<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<title>APP store</title>
<script type="text/javascript">
"use strict";

var IPList = ["112.124.113.235:30003","218.74.25.10:8100"];		//api for IP lists
var IPNum = 0;
var sid = '0f24d8d2956508cc571e67da23ee75ae47c1879c';
var dataBid = '4_6MfkPgJ03TSrrtlEawGf299PYzULu42g2m49xQl8U';

//Both check server availability and load hprose
function loadHprose(ip, callback) {
	var leither = 'vq-uYGXEf6yzbXV0_Th3SqzHBWyxuGJjryxVDUMY5f0';
	var appsKey = 'appstore-datalist-json';
	var script = document.createElement("script");
	script.type = "text/javascript";
	script.async = "async";
	if (script.readyState) { //IE
		script.onreadystatechange = function() {
			if (script.readyState == "loaded" || script.readyState == "complete") {
				script.onreadystatechange = null;
				callback(ip);
			};
		};
	} else { //Others
		script.onload = function() {
			callback(ip);
		};
	};
	script.addEventListener("error", function() {
		//try next server IP in a predefined list
		console.log("check next server=" + IPList[IPNum])
		checkServer(IPList[IPNum++]);
	});
	//here is a problem with illegitimate sid
	script.src = 'http://'+ip+'/getres?type=application/javascript&sid='+sid+'&bid='+dataBid+'&key='+leither;
	console.log(script);
	document.getElementsByTagName("head")[0].appendChild(script);		//load hprose first
};

function checkServer(ip) {
	if (ip===null || typeof(ip)==='undefined') {
		console.log("no server available");
		return;
	};
	//try to load leither from potential server
	loadHprose(ip, function(ip) {
		//the server is live, leither loaded successfully	
		var div = document.getElementById("loadZone");
		var leClient = leither.client(ip);
		var appID = "upgrade-file-location";
		leClient.get(sid, dataBid, appID, function(data) {
			var r = new FileReader();
			r.onload = function(e) {
				console.log(r.result);
				div.innerHTML = r.result;
			};
			r.readAsText(new Blob([data[1]], {type : "html/text"}));
		}, function(name, err) {
			console.error(err);
		});
	});
};

checkServer(IPList[IPNum++]);
</script>
</head>

<body>
	<div id="loadZone"></div>
</body>
</html>
